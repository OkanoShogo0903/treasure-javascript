<!DOCTYPE html>
<html>
<head>
    <title>Index</title>
</head>
<body>
    <h1>Let's fetch</h1>

    <h3>#1 Success</h3>
    <textarea rows="10" cols="60" id="success" disabled></textarea>

    <h3>#2 Error</h3>
    <textarea rows="10" cols="60" id="error" style="color:red" disabled></textarea>

    <script type="text/javascript">
    const successHandler = function(text) {
        document.getElementById("success").textContent = JSON.stringify(text);
    }
    const errorHandler = function(error) {
        document.getElementById("error").textContent = `${error.name}: ${error.message}`;
    }


    const parseJson = function(res) {
        return res.json();
    }

    /*
                try{
                    return JSON.parse(res.text());
                }
                catch(e){
                    throw new Error("not json error")
                }
     */

    // change this
    const request = function(method, url) {
        // promis 非同期通信をやるやつ
        return fetch(url)
            .then(function(res){
            if (res.ok){ // 2xx
                //console.log(res.json())
                //console.log(res.text())
                return res.text()
                //return JSON.parse(res.text());
            }
            if (res.status === 504){
                throw new Error("504 error")
            }
            throw new Error("4xx error")
            })
            .then(function(text){
                console.log(text)
                try{
                    return JSON.parse(text)
                }
                catch(e){
                    if ( e.name === "SyntaxError" ){
                        throw new Error("json error")
                    }
                }
            })
    }

    // #1 GET 2xx
    //request("GET", "http://localhost:3001/posts").then(successHandler).catch(errorHandler)

    // #2 GET 4xx
    // request("GET", "http://localhost:3001/404").then(successHandler).catch(errorHandler)

    // #3 GET 5xx
    // request("GET", "http://localhost:3001/timeout").then(successHandler).catch(errorHandler)

    // #4 GET 2xx but not json
    //request("GET", "http://localhost:3001/index.html").then(successHandler).catch(errorHandler)

    // #5 PUT
    //request("PUT", "http://localhost:3001/posts/1", {"id": 1, "title": "treasure", "author": "{{CHANGE YOUR NAME}}" }).then(successHandler).catch(errorHandler)

    // #6 GET /timeout with Timeout
    // requestWithTimeout(2000)("GET", "http://localhost:3001/timeout").then(successHandler).catch(errorHandler)

    // #7 GET /retryme until success
    // requestWithTimeout(2000)("GET", "http://localhost:3001/retryme").then(successHandler).catch(errorHandler)

    // #8 [GET http://localhost:3001/posts/1, GET http://localhost:3001/comments?post_id=1]

    </script>
</body>
</html>
